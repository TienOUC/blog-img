name: 手动压缩已有图片
# 仅支持手动触发，无自动触发
on:
  workflow_dispatch:

jobs:
  compress-all-images:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出仓库全部代码
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          fetch-depth: 0

      # 2. 安装系统级图片压缩工具（替代Squoosh，无兼容性问题）
      - name: 安装压缩工具
        run: |
          sudo apt-get update
          # 安装JPG/PNG/WebP压缩工具
          sudo apt-get install -y jpegoptim optipng webp

      # 3. 批量压缩所有图片（核心逻辑，分格式处理）
      - name: 压缩仓库中所有图片
        run: |
          # 压缩JPG/JPEG（质量80-90，保留原画质，overwrite覆盖原文件）
          find . -type f \( -iname "*.jpg" -o -iname "*.jpeg" \) -not -path "./.git/*" -exec jpegoptim --quality=80-90 --overwrite {} \;
          
          # 压缩PNG（级别6，无损压缩，force覆盖原文件）
          find . -type f -iname "*.png" -not -path "./.git/*" -exec optipng -o6 -force {} \;
          
          # 压缩WebP（质量85，有损压缩，覆盖原文件）
          find . -type f -iname "*.webp" -not -path "./.git/*" | while read -r img; do
            cwebp -q 85 -m 6 "$img" -o "$img"
          done

      # 4. 检查是否有图片被压缩（避免空提交）
      - name: 检查文件修改
        id: check_changes
        run: |
          git add .
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      # 5. 提交并推送修改（仅当有修改时执行）
      - name: 提交并推送修改
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --global user.name "Zephyr"       
          git config --global user.email "willtien@outlook.com"   
          git push_repo="https://${{ secrets.GH_PAT }}@github.com/TienOUC/blog-img.git"
          git push "$git_push_repo" main
          
          
          # 提交修改（[skip ci] 避免误触发CI）
          git commit -m "chore: 手动压缩已有图片 [skip ci]"
          # 推送修改到主分支（若分支是master，替换main为master）
          git push $git_push_repo main
